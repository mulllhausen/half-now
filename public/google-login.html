<html>
    <body>
        <div class="login-with">
            <span class="instructions">login to half-now with</span><br>
            <button class="facebook">facebook</button><br>
            <button class="google">google</button><br>
            <!--
                waiting for approval
                button class="twitter">twitter</button
            -->
            <button class="github">github</button><br>
            <!--
                need to pay a monthly subscription
                button class="microsoft">microsoft</button
            -->
            <label for="emailAddress">email</label>
            <input type="text" id="emailAddress" class="emailAddress"><br>
            <input type="checkbox" id="emailALink">
            <label for="emailALink">email me link to login</label><br>
            <label for="emailPassword">email password</label>
            <input type="text" id="emailPassword" class="emailPassword"><br>
            <button class="email">email</button><br>
            <button class="logout">logout of half-now</button>
        </div>
        <div class="user-data">
            <span class="half-now"></span>
            <span class="facebook"></span>
            <span class="google"></span>
            <span class="github"></span>
        </div>
        <script type="module">
import {
    googleSignIn,
    processGoogleUserData
} from '/signInWithGoogle.js';
import {
    facebookSignIn,
    processFacebookUserData
} from '/signInWithFacebook.js';
import {
    githubSignIn,
    processGithubUserData
} from '/signinWithGithub.js';
import {
    emailSignIn,
    completeEmailLinkSignin
} from '/signinWithEmail.js';

// the only global for this website.
// note: properties of const objects can be modified
const halfNowGlobals = {};

// from https://console.firebase.google.com/project/half-now/settings/general

// todo - use a module bundler to eliminate duplicate code
// https://firebase.google.com/docs/web/setup

// todo - link multiple auth providers
// https://firebase.google.com/docs/auth/web/account-linking

// Import the functions you need from the SDKs you need
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js';//'./firebase/app.js';
import {
    getAuth,
    signInWithRedirect,
    getRedirectResult,
    signOut,
    onAuthStateChanged
// } from './firebase/auth.js';
} from 'https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js';
//import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.17.2/firebase-analytics.js';
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
    apiKey: 'AIzaSyD1j1JxchDa4kCjIVxKPpZTFZDc9a084fw',
    authDomain: 'half-now.firebaseapp.com',
    databaseURL: 'https://half-now-default-rtdb.asia-southeast1.firebasedatabase.app',
    projectId: 'half-now',
    storageBucket: 'half-now.appspot.com',
    messagingSenderId: '1022216288188',
    appId: '1:1022216288188:web:fbf335e1f0918eb1345db9',
    measurementId: 'G-04C5HYLHKH'
};

// for email login - firebase.google.com/docs/auth/web/email-link-auth
halfNowGlobals.actionCodeSettings = {
    // URL you want to redirect back to. The domain (www.example.com) for this
    // URL must be in the authorized domains list in the Firebase Console.
    url: 'https://localhost:5000/login.html',
    // This must be true.
    handleCodeInApp: true
    //dynamicLinkDomain: 'example.page.link'
};

halfNowGlobals.userData = {};

// Initialize Firebase
const firebase = initializeApp(firebaseConfig);
//const analytics = getAnalytics(app);
const auth = getAuth(firebase);
//const user = auth.currentUser; // note: unreliable. is null even when user is logged in

document.querySelector('.login-with button.google')
    .addEventListener('click', () => googleSignIn(auth), false);

document.querySelector('.login-with button.facebook')
    .addEventListener('click', () => facebookSignIn(auth), false);

document.querySelector('.login-with button.github')
    .addEventListener('click', () => githubSignIn(auth), false);

document.querySelector('.login-with button.email')
    .addEventListener('click', handleEmailSignIn, false);

document.querySelector('.login-with button.logout').addEventListener('click', logout, false);

// https://firebase.google.com/docs/auth/web/manage-users
window.addEventListener('load', () => {
    onAuthStateChanged(auth, user => {
        if (user) {
            console.log('user is logged in', user);
            // https://firebase.google.com/docs/reference/js/firebase.User
            halfNowGlobals.userData = getNormalizedProviderData(user);
            console.log(halfNowGlobals.userData);
        } else {
            console.log('user is not logged in');
        }
    });
}, false);

// this set gets updated by each module
halfNowGlobals.authProviderIDWhitelist = new Set();
function updateAuthProviderWhitelist(providerID) {
    halfNowGlobals.authProviderIDWhitelist.add(providerID);
}

function handleEmailSignIn() {
    const emailALink = document.getElementById('emailALink').checked;
    const emailAddress = document.getElementById('emailAddress').value;
    const emailPassword = document.getElementById('emailPassword').value;
    emailSignIn(auth, emailAddress, emailALink, emailPassword);
}
window.addEventListener('load', () => {
    completeEmailLinkSignin(auth);
}, false);

function getNormalizedProviderData(user) {
    const provider = getProviderMetadata(user);
    if (!halfNowGlobals.providerIDWhitelist.has(provider.id)) {
        console.error(`unrecognised auth provider ${provider.id}`);
        return false;
    }
    const authUserData = halfNowGlobals.authUserData;
    if (isNullOrUndefined(authUserData[provider.id])) {
        authUserData[provider.id] = {};
    }
    const funcName = `process${provider.name}UserData`; // eg processGoogleUserData()
    authUserData[provider.id] = window[funcName](user);

    return authUserData;
}

function getProviderMetadata(user) {
    const id = user.providerData[0].providerId; // eg. 'google.com'
    return {
        id: id,
        name: id.split('.')[0]
    };
}

function renderUserData(data) {
    if (!auth.currentUser) return;
    document.querySelector('.google-user-data').innerHTML = data;
}

function logout() {
    if (!auth.currentUser) {
        console.log('no user is logged in');
        return;
    }
    signOut(auth).then(() => {
        console.log('Sign-out successful');
    }).catch((error) => {
        console.log('An error happened');
    });
}

/*addEventListener('dontload', (event) => {
    getRedirectResult(auth)
        .then((result) => {
            // This gives you a Google Access Token to access Google APIs
            const credential = GoogleAuthProvider.credentialFromResult(result);
            const token = credential.accessToken;

            // The signed-in user info.
            const user = result.user;
            renderUserData(user);
        }).catch((error) => {
            // Handle Errors here.
            const errorCode = error.code;
            if (errorCode == null) return;

            const errorMessage = error.message;
            // The email of the user's account used.
            const email = error.customData.email;
            // The AuthCredential type that was used.
            const credential = GoogleAuthProvider.credentialFromError(error);
        });
});*/
function isNullOrUndefined(x) {
    return (x == null);
}
        </script>
        <!-- script src="/signinWithGoogle.js" type="module"></script>
        <script src="/signinWithFacebook.js" type="module"></script>
        <script src="/signinWithGithub.js" type="module"></script>
        <script src="/signinWithEmail.js" type="module"></script -->
    </body>
</html>
